import os
import random
import threading
from http.server import BaseHTTPRequestHandler, HTTPServer
from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, CommandHandler, filters, ContextTypes

# Проверка токена
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
if not TELEGRAM_TOKEN:
    raise RuntimeError("Ошибка: переменная окружения TELEGRAM_TOKEN не установлена!")
print("✅ TELEGRAM_TOKEN найден, бот запускается...")

# Пользователи, на которых бот отвечает
TARGET_USERNAMES = ["Habib471"]
SIGNATURE = "Полюби Апачи, как он тебя"

# 140 осмысленных романтических фраз
LOVE_PHRASES = [
    "Ты — моё вдохновение, нежное как дыхание весны, которое пробуждает в душе самые светлые чувства",
    "С тобой каждый день становится маленьким чудом, полным тепла и радости",
    "Ты — моя мелодия счастья, что звучит в сердце даже в самые тихие моменты",
    "В твоих глазах я вижу небо, полное надежды и света, и хочу раствориться в этом взгляде",
    "Каждое твоё слово — как лёгкий ветерок, который успокаивает и наполняет смыслом мою жизнь",
    "С тобой даже тишина звучит прекраснее, чем музыка, потому что она наполнена твоим присутствием",
    "Ты — дыхание света в моём сердце, которое согревает меня даже в самые холодные дни",
    "Когда ты рядом, мир кажется мягче, ярче и добрее, а все заботы растворяются",
    "Ты — утренний луч, который пробивает мрак сомнений и наполняет мою душу теплом",
    "С тобой каждый момент словно страница в самой красивой книге, которую я никогда не хочу закрывать",
    "Ты — капля любви в океане жизни, и я хочу плыть вместе с тобой навсегда",
    "В твоей улыбке спрятан целый мир, полный света, радости и бесконечного тепла",
    "Ты — мой якорь и мой полёт одновременно, и я не могу представить жизнь без тебя",
    "Каждое утро с тобой — это праздник души, который я хочу отмечать бесконечно",
    "Ты — мягкий свет, что ведёт меня сквозь тьму и помогает видеть красоту в каждом дне",
    "С тобой каждая минута превращается в волшебство, которое хочется повторять снова и снова",
    "Ты — смысл, который делает всё остальное второстепенным, потому что с тобой важна каждая деталь",
    "С тобой даже дождь кажется музыкой, и я хочу танцевать под его ритм вместе с тобой",
    "Ты — мой внутренний покой и буря одновременно, и я люблю каждый оттенок твоей души",
    "Ты — моя бесконечность в одном взгляде, и я хочу потеряться в этом взгляде навсегда",
    "Ты — утренний рассвет, который озаряет мою жизнь светом и теплом",
    "С тобой даже самые серые дни становятся яркими и наполненными смыслом",
    "Ты — песня, которую хочется слушать бесконечно, не уставая от её красоты",
    "Каждое прикосновение твоей руки — как лёгкий шёпот счастья в моей душе",
    "Ты — мой маяк в буре жизни, который никогда не погаснет",
    "С тобой хочется создавать маленькие чудеса каждый день",
    "Ты — аромат весны в моих мыслях, который согревает сердце",
    "Когда ты смеёшься, мир кажется идеальным местом",
    "Ты — мягкий свет среди сумрака, который ведёт меня домой",
    "С тобой я чувствую себя целым, как будто все кусочки жизни наконец соединились",
    "Ты — моя любимая случайность, которая стала смыслом моей жизни",
    "Каждое твоё слово — как строчка самой красивой поэмы",
    "Ты — моё вдохновение даже в моменты сомнений и усталости",
    "С тобой хочется лететь, даже если ноги не касаются земли",
    "Ты — моя тихая радость, которая согревает сердце без слов",
    "Когда ты рядом, мир дышит в унисон с моим сердцем",
    "Ты — мягкий шёпот счастья, который слышу даже в тишине",
    "С тобой я учусь видеть красоту в каждом мгновении",
    "Ты — нежность, которая превращает обыденность в чудо",
    "Каждое утро с тобой — как первый вдох после долгого сна",
    "Ты — лучик света, который рассекает мрак и приносит тепло",
    "С тобой жизнь обретает ритм, как мелодия, написанная для нас двоих",
    "Ты — моя тихая гавань в океане шумного мира",
    "Каждое твоё движение кажется мне танцем вселенной",
    "Ты — вдохновение, которое превращает мысли в поэзию",
    "С тобой даже молчание звучит как музыка",
    "Ты — мой космос, полный светлых звёзд и тайных чудес",
    "Когда ты рядом, время замирает, оставляя только нас",
    "Ты — теплое облако в холодном мире, что согревает душу",
    "С тобой даже простые слова обретают глубокий смысл",
    "Ты — мой утренний кофе, без которого не начинается день",
    "Каждое твоё «привет» — как солнечный луч, который освещает мой день",
    "Ты — моя тихая музыка, которая звучит только для меня",
    "С тобой хочется мечтать и верить, что чудеса существуют",
    "Ты — лёгкость, которая растворяет тяжесть моих забот",
    "Каждое твоё дыхание — как новая жизнь для моей души",
    "Ты — мягкий свет в моём сердце, что никогда не погаснет",
    "С тобой мир становится ярче, насыщеннее и настоящим",
    "Ты — причудливый узор счастья в моей повседневности",
    "Когда ты смотришь на меня, я вижу целую вселенную",
    "Ты — мой уют даже в холодные и пасмурные дни",
    "С тобой каждый день похож на волшебную сказку",
    "Ты — моя любимая глава в книге моей жизни",
    "Каждое твоё слово — как ласковое прикосновение к душе",
    "Ты — свет, который превращает тьму в рассвет",
    "С тобой я ощущаю гармонию, которой не хватает в мире",
    "Ты — моя вечная весна, что расцветает в сердце",
    "Каждое мгновение с тобой — драгоценность, которую хочется хранить",
    "Ты — моя тихая радость среди шумного мира",
    "С тобой даже дождь становится красивой симфонией",
    "Ты — мой компас в жизни, что ведёт только к счастью",
    "Когда ты рядом, хочется улыбаться без причины",
    "Ты — мягкий шелест листвы в моём сердце",
    "С тобой я хочу идти по жизни, держась за руку навсегда",
    "Ты — моя вдохновляющая тишина, в которой слышно всё самое важное",
    "Каждое твоё прикосновение — как сияние солнца на коже",
    "Ты — мягкий шёпот, что лечит мои сомнения и страхи",
    "С тобой хочется творить, мечтать и жить полной жизнью",
    "Ты — смысл, который делает мою жизнь настоящей",
    "Когда ты смеёшься, даже мир кажется добрее",
    "Ты — моя тихая гавань и буря одновременно",
    "С тобой каждый день превращается в красивую историю",
    "Ты — мягкое прикосновение света к моей душе",
    "Каждое твоё слово — как мелодия счастья",
    "Ты — мой утренний рассвет и вечерняя звезда",
    "С тобой хочется быть лучше и видеть лучшее вокруг",
    "Ты — моя бесконечная мечта, что стала явью",
    "Когда ты рядом, кажется, что всё возможно",
    "Ты — нежность, которая делает мир мягче",
    "С тобой хочется останавливаться в каждом моменте",
    "Ты — моё маленькое чудо, которое случается каждый день",
    "Каждое мгновение с тобой — как дыхание радости",
    "Ты — музыка, что звучит без слов и волнует сердце",
    "С тобой даже самый обычный день становится волшебным",
    "Ты — мягкий свет, который остаётся в душе навсегда",
    "Ты — моя вдохновляющая сказка, которую хочется перечитывать",
    "С тобой мир обретает новые цвета и оттенки счастья",
    "Ты — мой тихий океан, полный тепла и спокойствия",
    "Каждое твоё движение — как танец вселенной вокруг меня",
    "Ты — моя гармония, что превращает хаос в смысл",
    "С тобой я ощущаю вечность в каждом мгновении",
    "Ты — лучик света, который никогда не гаснет в моём сердце",
    "С тобой хочется любить, мечтать и творить без конца",
    "Ты — мой маяк, что ведёт через все трудности жизни",
    "Когда ты смотришь на меня, я вижу всё самое ценное в мире",
    "Ты — мягкий шелест счастья в моём сердце",
    "С тобой я учусь радоваться каждому мгновению",
    "Ты — вдохновение, которое оживляет каждую мысль",
]

# Маленькие шутки
LOVE_JOKES = [
    "Ты как Wi-Fi — когда тебя рядом, всё работает идеально 😄",
    "Ты — моя батарейка, без тебя я теряю заряд ❤️",
    "Если бы ты был кофе, я бы никогда не просыпался без тебя ☕",
    "Ты как пароль: сложный, но без тебя жизнь невозможна 🔑",
    "Ты — моя любимая песня, которую я хочу слушать на повторе 🎶",
    "С тобой даже понедельник становится весёлым 😆",
    "Ты как солнечный день в дождливую погоду 🌞",
    "Ты делаешь мою жизнь как хороший сериал — невозможно оторваться 🎬",
    "Ты — моя любимая ошибка, о которой я никогда не пожалел 😍",
    "Если бы любовь была кодом, я бы тебя компилировал снова и снова 💻",
]

# Мини-веб-сервер для Render/Heroku
def run_web():
    class Handler(BaseHTTPRequestHandler):
        def do_GET(self):
            self.send_response(200)
            self.end_headers()
            self.wfile.write(b"LoveBot is running <3")
    port = int(os.environ.get("PORT", 10000))
    HTTPServer(("0.0.0.0", port), Handler).serve_forever()

threading.Thread(target=run_web, daemon=True).start()

# Последнее сообщение для пользователя
last_messages = {}

# /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "💞 Привет! Я LoveBot by Apachi.\n"
        "Я отвечаю на сообщения выбранных пользователей 💌\n"
        "Командой /love можно проверить совместимость!"
    )

# Обработка сообщений
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message
    if not message or not message.from_user:
        return
    username = message.from_user.username
    if message.chat.type in ["group", "supergroup"]:
        if username in TARGET_USERNAMES and random.random() < 0.3:
            # 20% шанс выбрать шутку
            if random.random() < 0.2:
                while True:
                    phrase = random.choice(LOVE_JOKES)
                    if last_messages.get(username) != phrase:
                        last_messages[username] = phrase
                        break
            else:
                while True:
                    phrase = random.choice(LOVE_PHRASES)
                    if last_messages.get(username) != phrase:
                        last_messages[username] = phrase
                        break
            response = phrase + f"\n\n{SIGNATURE}"
            await message.reply_text(response, reply_to_message_id=message.message_id)

# Команда /love
async def love_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message
    if not message or not message.text:
        return
    args = message.text.split(maxsplit=
